<html>
<head>
    <title>RPG</title>
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="/css/my.css" rel="stylesheet">
</head>
<body onload="get_List(0)">
<h1>RPG admin panel</h1>

<label for="countAccountPerPage"> Number of accounts per page: </label>
<select id="countAccountPerPage" onchange="get_List(0)">
    <option value="3"> 3</option>
    <option value="5"> 5</option>
    <option value="10"> 10</option>
    <option value="15"> 15</option>
    <option value="20"> 20</option>

</select>

<table id="list" class="listTable">
    <tr>
        <th> #</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
</table>
<div id="button_pages">Number page:</div>

<hr>
<h2>Create new account</h2>
<label for="input_name_new_account">Name:</label>
<input type="text" id="input_name_new_account" name="name" required size="12" maxlength="12">
<br>
<label for="input_title_new_account">Title:</label>
<input type="text" id="input_title_new_account" name="title" required size="30" maxlength="30">
<br>
<label for="input_race_new_account">Race:</label>
<select id="input_race_new_account" name='race'>
    <option value='HUMAN'>HUMAN</option>
    <option value='DWARF'>DWARF</option>
    <option value='ELF'>ELF</option>
    <option value='GIANT'>GIANT</option>
    <option value='ORC'>ORC</option>
    <option value='TROLL'>TROLL</option>
    <option value='HOBBIT'>HOBBIT</option>
</select>
<br>
<label for="input_profession_new_account">Profession:</label>
<select id="input_profession_new_account" name='profession'>
    <option value='WARRIOR'>WARRIOR</option>
    <option value='ROGUE'>ROGUE</option>
    <option value='SORCERER'>SORCERER</option>
    <option value='CLERIC'>CLERIC</option>
    <option value='PALADIN'>PALADIN</option>
    <option value='NAZGUL'>NAZGUL</option>
    <option value='WARLOCK'>WARLOCK</option>
    <option value='DRUID'>DRUID</option>
</select>
<br>
<label for="input_level_new_account">Level:</label>
<input type="number" id="input_level_new_account" name="level" min="0" max="100">
<br>
<label for="input_birthday_new_account">Level:</label>
<input type="date" id="input_birthday_new_account" name="birthday" min="2000-01-01" max="2500-12-31">
<br>
<label for="input_banned_new_account">Banned:</label>
<select id="input_banned_new_account" name='banned'>
    <option value='false'>false</option>
    <option value='true'>true</option>
</select>
<br><br>

<span>
    <button type="submit" onclick="createAccount()">Save</button>
</span>

<script>
    function get_List(page_number) {

        $("tr:has(td)").remove();

        let url = "/rest/players?";

        let accountCount = $("#countAccountPerPage").val();
        if (accountCount == null) {
            accountCount = 3;
        }

        url = url.concat("pageSize=").concat(accountCount);

        if (page_number == null) {
            page_number = 0;
        }
        url = url.concat("&pageNumber=").concat(page_number);
        console.log("url=" + url);

        $.get(url, function (playersList) {
            $.each(playersList, function (i, item) {
                $('<tr>').html("<td>"
                    + item.id + "</td><td>"
                    + item.name + "</td><td>"
                    + item.title + "</td><td>"
                    + item.race + "</td><td>"
                    + item.profession + "</td><td>"
                    + item.level + "</td><td>"
                    + new Date(item.birthday).toLocaleDateString() + "</td><td>"
                    + item.banned + "</td><td>" +
                    "<button id='button_edit" + item.id + "' onclick='editAccount("+item.id+")'>"
                    + "<img src='/img/edit.png'>"
                    + "</button>" + "</td><td>"
                    + "<button id='button_delete" + item.id + "'onclick='deleteAccount(" + item.id + ")'>"
                    + "<img src='/img/delete.png'>"
                    + "</button>" + "</td>"
                ).appendTo("#list");
            });
        });
        let maxAccount = getAccountCount();

        let pagesCountButton = Math.ceil(maxAccount / accountCount);

        $("button.pagesButtonStile").remove();

        for (let i = 0; i < pagesCountButton; i++) {
            let buttonPages = "<button>" + (i + 1) + "</button>";
            let button = $(buttonPages)
                .attr('id', "button_pages" + i)
                .attr('onclick', "get_List(" + i + ")")
                .addClass('pagesButtonStile');
            $('#button_pages').append(button);
        }

        let ident = "#button_pages" + page_number;
        $(ident).css('color', "red");
    }

    function getAccountCount() {
        let url = "/rest/players/count";
        let count = 0;
        $.ajax({
            url: url,
            async: false,
            success: function (accountCount) {
                count = parseInt(accountCount);
            }
        })
        return count;
    }

    function deleteAccount(id) {
        let url = "/rest/players/" + id;
        $.ajax({
            url: url,
            type: 'DELETE',
            success: function () {
                get_List(getPage());
            }
        });
    }

    function editAccount(id){
        let ident_edit="#button_edit"+id;
        let ident_delete="#button_delete"+id;
        $(ident_delete).remove();
        let save_edit_image="<img src='/img/save.png'>";
        $(ident_edit).html(save_edit_image);

        let parent_element=$(ident_edit).parent().parent();
        let children= parent_element.children();
        let td_name = children[1];
        td_name.innerHTML = "<input id='input_name"+id+"'type='text' value='"+td_name.innerHTML+"'>";

        let td_title = children[2];
        td_title.innerHTML = "<input id='input_title"+id+"'type='text' value='"+td_title.innerHTML+"'>";

        let td_race=children[3];
        let race_id="#select_race"+id;
        let race_value=td_race.innerHTML;
        td_race.innerHTML=getListRace(id);
        $(race_id).val(race_value).change();

        let td_profession=children[4];
        let profession_id="#select_profession"+id;
        let profession_value=td_profession.innerHTML;
        td_profession.innerHTML=getListProfession(id);
        $(profession_id).val(profession_value).change();

        let td_banned=children[7];
        let banned_id="#select_banned"+id;
        let banned_value=td_banned.innerHTML;
        td_banned.innerHTML=getListBanned(id);
        $(banned_id).val(banned_value).change();

        let save_tag="saveAccount("+id+")";
        $(ident_edit).attr('onclick',save_tag);

    }

    function createAccount(){
        let value_name =$("#input_name_new_account").val();
        let value_title =$("#input_title_new_account").val();
        let value_race =$("#input_race_new_account").val();
        let value_profession =$("#input_profession_new_account").val();
        let value_level=$("#input_level_new_account").val();
        let value_birthday=$("#input_birthday_new_account").val();
        let value_banned =$("#input_banned_new_account").val();


        let url="/rest/players";

        $.ajax({
            url: url,
            type: 'POST',
            dataType:'json',
            contentType:'application/json;charset=UTF-8',
            async: false,
            data:JSON.stringify({
                "name":value_name,
                "title":value_title,
                "race":value_race,
                "profession":value_profession,
                "level":value_level,
                "birthday":new Date(value_birthday).getTime(),
                "banned":value_banned
            }),
            success:function (){
                $("#input_name_new_account"+id).val("");
                $("#input_title_new_account"+id).val("");
                $("#input_race_new_account"+id).val("");
                $("#input_profession_new_account"+id).val("");
                $("#input_level_new_account"+id).val("");
                $("#input_birthday_new_account"+id).val("");
                $("#input_banned_new_account"+id).val("");
                get_List(getPage());

            }
        });

    }

    function saveAccount(id){
        let value_name =$("#input_name"+id).val();
        let value_title =$("#input_title"+id).val();
        let value_race =$("#select_race"+id).val();
        let value_profession =$("#select_profession"+id).val();
        let value_banned =$("#select_banned"+id).val();

        let url="/rest/players/"+id;
        $.ajax({
            url: url,
            type: 'POST',
            dataType:'json',
            contentType:'application/json;charset=UTF-8',
            async: false,
            data:JSON.stringify({
                "name":value_name,
                "title":value_title,
                "race":value_race,
                "profession":value_profession,
                "banned":value_banned
            }),
            success:function (){
                get_List(getPage());
            }
        });
    }

    function getListRace(id){
        let race_id= "select_race"+id;
        return "<label for='race'></label>"
        +"<select id=" +race_id+ " name='race'>"
        +"<option value='HUMAN'>HUMAN</option>"
        +"<option value='DWARF'>DWARF</option>"
        +"<option value='ELF'>ELF</option>"
        +"<option value='GIANT'>GIANT</option>"
        +"<option value='ORC'>ORC</option>"
        +"<option value='TROLL'>TROLL</option>"
        +"<option value='HOBBIT'>HOBBIT</option>"
        +"</select>";
    }
    function getListProfession(id) {
        let profession_id = "select_profession" + id;
        return "<label for='race'></label>"
            + "<select id=" + profession_id + " name='race'>"
            + "<option value='WARRIOR'>WARRIOR</option>"
            + "<option value='ROGUE'>ROGUE</option>"
            + "<option value='SORCERER'>SORCERER</option>"
            + "<option value='CLERIC'>CLERIC</option>"
            + "<option value='PALADIN'>PALADIN</option>"
            + "<option value='NAZGUL'>NAZGUL</option>"
            + "<option value='WARLOCK'>WARLOCK</option>"
            + "<option value='DRUID'>DRUID</option>"
            + "</select>";
    }


        function getListBanned(id){
            let banned_id= "select_banned"+id;
            return "<label for='banned'></label>"
                +"<select id=" +banned_id+ " name='banned'>"
                +"<option value='false'>false</option>"
                +"<option value='true'>true</option>"
                +"</select>";
    }


    function getPage() {
        let get_page = 1;
        $('button:parent(div)').each(function () {
            if ($(this).css('color') === 'rgb(255,0,0)') {
             get_page = $(this).text();
            }
        });
        return parseInt(get_page) - 1;
    }


</script>
</body>
</html>